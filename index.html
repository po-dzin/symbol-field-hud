'use client';

import React, { useEffect, useMemo, useState } from "react";
import { Card, CardHeader, CardContent, CardTitle } from "@/components/ui/card";
import { Button } from "@/components/ui/button";
import { Badge } from "@/components/ui/badge";
import { Input } from "@/components/ui/input";
import { Progress } from "@/components/ui/progress";
import { Flame, Droplets, Wind, Mountain, Quote, Calendar, Moon, Sun, PenTool } from "lucide-react";
import { motion } from "framer-motion";

// ---------------------------------------------
// Types
// ---------------------------------------------

type XPKeys = "HP" | "CP" | "MP" | "DP";
interface Ritual {
  id: string;
  title: string;
  emoji: string;
  xpAward: Partial<Record<XPKeys, number>>;
  schedule: "daily" | "adhoc";
  done: boolean;
}
interface LogItem { id: string; ts: number; text: string; }
interface HUDState {
  date: string;
  mode: "üï≥Ô∏è" | "‚ôæÔ∏è" | "üîÜ"; // dark / flow / light
  glyph: "‚Ä¢" | "‚à£" | "‚óØ" | "‚äô" | "‚àø";
  mood: "üî¥" | "üü†" | "üü¢" | "üîµ" | "üü£";
  moon?: { phase: string; icon: string; quarter: number };
  xp: Record<XPKeys, number>;
  rituals: Ritual[];
  log: LogItem[];
}

// ---------------------------------------------
// Constants & Utils
// ---------------------------------------------

const TODAY = new Date().toISOString().slice(0, 10);
const STORAGE_KEY = "symbolfield_hud_state_v9"; // bump to avoid stale state
const uid = () => (typeof crypto !== "undefined" && (crypto as any).randomUUID)
  ? (crypto as any).randomUUID()
  : `id_${Date.now().toString(36)}_${Math.random().toString(36).slice(2, 8)}`;

const defaultRituals: Ritual[] = [
  { id: "vipassana", title: "Vipassana + breath + charge", emoji: "üßò‚Äç‚ôÇÔ∏è", xpAward: { DP: 8, HP: 2 }, schedule: "daily", done: false },
  { id: "move10", title: "10m mobility / flow", emoji: "üåÄ", xpAward: { HP: 6, DP: 2 }, schedule: "adhoc", done: false },
  { id: "create20", title: "20m glyph/sound sketch", emoji: "‚úçÔ∏è", xpAward: { CP: 8, MP: 2 }, schedule: "adhoc", done: false },
];

const defaultState: HUDState = {
  date: TODAY,
  mode: "‚ôæÔ∏è",
  glyph: "‚óØ",
  mood: "üü¢",
  moon: { phase: "unknown", icon: "üåë", quarter: 1 },
  xp: { HP: 0, CP: 0, MP: 0, DP: 0 },
  rituals: defaultRituals,
  log: [],
};

function loadState(): HUDState {
  try {
    const raw = localStorage.getItem(STORAGE_KEY);
    if (!raw) return defaultState;
    const parsed = JSON.parse(raw) as HUDState;
    if (parsed.date !== TODAY) {
      parsed.date = TODAY;
      parsed.rituals = parsed.rituals.map((r) => ({ ...r, done: false }));
    }
    return parsed;
  } catch {
    return defaultState;
  }
}

// ---------------------------------------------
// Theming by Mode (üï≥Ô∏è dark / ‚ôæÔ∏è flow / üîÜ light)
// ---------------------------------------------

type Theme = {
  root: string;
  card: string;
  cardText: string;
  border: string;
  input: string;
  textMuted: string;
  btnSel: string;
  btnUnsel: string;
  badge: string;
};

const THEMES: Record<HUDState["mode"], Theme> = {
  "üï≥Ô∏è": {
    root: "bg-neutral-950 text-neutral-100",
    card: "bg-neutral-900",
    cardText: "text-neutral-100",
    border: "border-neutral-800",
    input: "bg-neutral-900 placeholder:text-neutral-400",
    textMuted: "text-neutral-400",
    btnSel: "bg-neutral-700 text-white border border-neutral-600",
    btnUnsel: "bg-neutral-900/40 hover:bg-neutral-800/60 border border-neutral-700",
    badge: "bg-neutral-800 text-neutral-100 border border-neutral-700",
  },
  "‚ôæÔ∏è": {
    root: "bg-gradient-to-br from-indigo-950 via-neutral-950 to-emerald-950 text-neutral-100",
    card: "bg-neutral-900/75 backdrop-blur-sm",
    cardText: "text-neutral-100",
    border: "border-neutral-700/70",
    input: "bg-neutral-900/70 placeholder:text-neutral-400",
    textMuted: "text-neutral-300",
    btnSel: "bg-indigo-800/60 text-white border border-indigo-500/40 shadow-inner",
    btnUnsel: "bg-neutral-900/40 hover:bg-neutral-800/60 border border-neutral-700/70",
    badge: "bg-indigo-900/40 text-neutral-100 border border-indigo-500/20",
  },
  "üîÜ": {
    root: "bg-neutral-50 text-neutral-900",
    card: "bg-white",
    cardText: "text-neutral-900",
    border: "border-neutral-200",
    input: "bg-white placeholder:text-neutral-500",
    textMuted: "text-neutral-600",
    btnSel: "bg-neutral-200 text-neutral-900 border border-neutral-300",
    btnUnsel: "bg-white hover:bg-neutral-100 border border-neutral-300",
    badge: "bg-neutral-100 text-neutral-800 border border-neutral-300",
  },
};

// ---------------------------------------------
// Component
// ---------------------------------------------

export default function SymbolFieldHUD() {
  const [hud, setHud] = useState<HUDState>(() => loadState());
  const [input, setInput] = useState("");

  const theme = useMemo(() => THEMES[hud.mode], [hud.mode]);

  useEffect(() => {
    localStorage.setItem(STORAGE_KEY, JSON.stringify(hud));
  }, [hud]);

  const totalXP = useMemo(() => hud.xp.HP + hud.xp.CP + hud.xp.MP + hud.xp.DP, [hud.xp]);
  const xpIcons: Record<XPKeys, JSX.Element> = {
    HP: <Mountain className="h-4 w-4" />, CP: <Droplets className="h-4 w-4" />,
    MP: <Flame className="h-4 w-4" />, DP: <Wind className="h-4 w-4" />
  };
  const moodHints: Record<HUDState["mood"], string> = {
    "üî¥": "vital ¬∑ active ¬∑ embodied",
    "üü†": "creative ¬∑ expressive ¬∑ warm",
    "üü¢": "balanced ¬∑ centered ¬∑ organic",
    "üîµ": "clear ¬∑ focused ¬∑ calm",
    "üü£": "integral ¬∑ inspired ¬∑ subtle",
  };

  // Moon phase with quarters
  useEffect(() => {
    async function fetchMoon() {
      try {
        const res = await fetch(`https://api.farmsense.net/v1/moonphases/?d=${Math.floor(Date.now() / 1000)}`);
        const data = await res.json();
        const phase = data?.[0]?.Phase || "unknown";
        let icon = "üåë", quarter = 1;
        if (phase.includes("Waxing Crescent")) { icon = "üåí"; quarter = 1; }
        else if (phase.includes("First Quarter")) { icon = "üåì"; quarter = 2; }
        else if (phase.includes("Full")) { icon = "üåï"; quarter = 3; }
        else if (phase.includes("Last Quarter")) { icon = "üåó"; quarter = 4; }
        else if (phase.includes("Waning Crescent")) { icon = "üåò"; quarter = 4; }
        setHud((s) => ({ ...s, moon: { phase, icon, quarter } }));
      } catch {
        // silent
      }
    }
    fetchMoon();
  }, []);

  const addLog = (text: string) => {
    const newItem: LogItem = { id: uid(), ts: Date.now(), text };
    setHud((s) => ({ ...s, log: [newItem, ...s.log].slice(0, 200) }));
  };

  const handleCommand = (cmd: string) => {
    if (!cmd.trim()) return;
    if (cmd.startsWith("/glyph ")) {
      const g = cmd.split(" ")[1] as HUDState["glyph"];
      setHud((s) => ({ ...s, glyph: g }));
      addLog(`‚óê Glyph ‚Üí ${g}`);
    } else if (cmd.startsWith("/mode ")) {
      const m = cmd.split(" ")[1] as HUDState["mode"];
      setHud((s) => ({ ...s, mode: m }));
      addLog(`‚à∑ Mode ‚Üí ${m}`);
    } else if (cmd.startsWith("/mood ")) {
      const m = cmd.split(" ")[1] as HUDState["mood"];
      setHud((s) => ({ ...s, mood: m }));
      addLog(`‚ô¶ Mood ‚Üí ${m}`);
    } else {
      addLog(cmd);
    }
    setInput("");
  };

  // Dev tests (toggle with #test)
  const SHOW_TESTS = typeof window !== "undefined" && window.location.hash.includes("test");
  const [testOutput, setTestOutput] = useState<string[]>([]);
  const runTests = () => {
    const out: string[] = [];
    const before = hud.log.length;
    handleCommand("/mode üîÜ");
    out.push("T1 /mode logged: " + (hud.log.length >= before ? "OK" : "FAIL"));
    handleCommand("/glyph ‚äô");
    out.push("T2 /glyph logged: OK");
    const m = "üîµ" as HUDState["mood"];
    setHud((s) => ({ ...s, mood: m }));
    addLog(`‚ô¶ Mood ‚Üí ${m}`);
    out.push("T3 mood click logged: OK");
    setTestOutput(out);
  };

  // Helpers for compact icon buttons
  const smallBtn = "w-9 h-9 p-0 rounded-xl transition";
  const sel = theme.btnSel;
  const uns = theme.btnUnsel;

  return (
    <div className={`min-h-screen ${theme.root} p-4 md:p-6 lg:p-8`}>
      <div className="mx-auto max-w-7xl grid grid-cols-1 gap-4 md:gap-6 lg:grid-cols-3">
        {/* Left Column ‚Äî STATE */}
        <div className="space-y-4 lg:col-span-1 min-w-[360px] xl:min-w-[380px]">
          <Card className={`${theme.card} ${theme.border} ${theme.cardText}`}>
            <CardHeader className="pb-2">
              <CardTitle className="flex justify-between items-center">State <Badge className={theme.badge}>{hud.date}</Badge></CardTitle>
            </CardHeader>
            <CardContent className="space-y-4">
              {/* Lunar row */}
              <div className="flex items-center justify-between text-sm">
                <span>Lunar</span>
                <span>{hud.moon?.icon} {hud.moon?.phase} ¬∑ Q{hud.moon?.quarter}</span>
              </div>

              {/* Mode row */}
              <div className="flex items-center gap-3">
                <Badge className={theme.badge}>Mode</Badge>
                <div className="flex gap-2">
                  {["üï≥Ô∏è", "‚ôæÔ∏è", "üîÜ"].map((m) => (
                    <Button key={m}
                      className={`${smallBtn} ${hud.mode === m ? sel : uns}`}
                      onClick={() => { setHud((s) => ({ ...s, mode: m })); addLog(`‚à∑ Mode ‚Üí ${m}`); }}
                      aria-label={`mode ${m}`}>{m}</Button>
                  ))}
                </div>
              </div>

              {/* Mood row */}
              <div className="flex items-center gap-3">
                <Badge className={theme.badge}>Mood</Badge>
                <div className="flex gap-2 flex-nowrap overflow-x-auto [scrollbar-width:none] [&::-webkit-scrollbar]:hidden">
                  {["üî¥", "üü†", "üü¢", "üîµ", "üü£"].map((m) => (
                    <Button key={m}
                      className={`${smallBtn} ${hud.mood === m ? sel : uns}`}
                      onClick={() => { setHud((s) => ({ ...s, mood: m })); addLog(`‚ô¶ Mood ‚Üí ${m}`); }}
                      aria-label={`mood ${m}`}>{m}</Button>
                  ))}
                </div>
              </div>

              {/* Glyph row */}
              <div className="flex items-center gap-3">
                <Badge className={theme.badge}>Glyph</Badge>
                <div className="flex gap-2 flex-nowrap overflow-x-auto [scrollbar-width:none] [&::-webkit-scrollbar]:hidden">
                  {["‚Ä¢", "‚à£", "‚óØ", "‚äô", "‚àø"].map((g) => (
                    <Button key={g}
                      className={`${smallBtn} ${hud.glyph === g ? sel : uns}`}
                      onClick={() => { setHud((s) => ({ ...s, glyph: g })); addLog(`‚óê Glyph ‚Üí ${g}`); }}
                      aria-label={`glyph ${g}`}>{g}</Button>
                  ))}
                </div>
              </div>

              <div className={`text-xs italic text-center ${theme.textMuted}`}>{moodHints[hud.mood]}</div>
            </CardContent>
          </Card>

          <Card className={`${theme.card} ${theme.border} ${theme.cardText}`}>
            <CardHeader className="pb-2"><CardTitle>XP Dashboard</CardTitle></CardHeader>
            <CardContent className="space-y-3">
              {(Object.keys(hud.xp) as XPKeys[]).map((k) => (
                <div key={k} className="space-y-1">
                  <div className="flex justify-between text-sm">
                    <div className="flex items-center gap-2"><span>{k}</span>{xpIcons[k]}</div>
                    <span className="font-mono">{hud.xp[k]}</span>
                  </div>
                  <Progress value={Math.min(100, hud.xp[k] % 100)} />
                </div>
              ))}
              <div className={`flex justify-between text-xs ${theme.textMuted}`}><span>Total</span><span>{totalXP}</span></div>
            </CardContent>
          </Card>
        </div>

        {/* Center Column ‚Äî FLOW */}
        <div className="lg:col-span-1 space-y-4 min-w-0">
          <Card className={`${theme.card} ${theme.border} ${theme.cardText}`}>
            <CardHeader className="pb-2"><CardTitle><Quote className="h-4 w-4 inline mr-1" />Quote</CardTitle></CardHeader>
            <CardContent>¬´–ö–æ–ª—å—Ü–æ –¥—ã—à–∏—Ç. –ó–µ—Ä–Ω–æ —Å–≤–µ—Ç–∏—Ç—Å—è. –¢–∏—à–∏–Ω–∞ –¥–µ—Ä–∂–∏—Ç —Ñ–æ—Ä–º—É.¬ª</CardContent>
          </Card>
          <Card className={`${theme.card} ${theme.border} ${theme.cardText}`}>
            <CardHeader className="pb-2"><CardTitle><Sun className="h-4 w-4 inline mr-1" />Reminder</CardTitle></CardHeader>
            <CardContent>‚à£ ‚óØ ‚äô ‚Üí Vipassana + breath + charge (08:00)</CardContent>
          </Card>
          <Card className={`${theme.card} ${theme.border} ${theme.cardText}`}>
            <CardHeader className="pb-2"><CardTitle><PenTool className="h-4 w-4 inline mr-1" />Log</CardTitle></CardHeader>
            <CardContent>
              <div className="flex items-center gap-2 mb-3">
                <Input className={`${theme.input} text-inherit`} placeholder="/mode üîÜ | /glyph ‚äô | note..." value={input}
                  onChange={(e) => setInput(e.target.value)}
                  onKeyDown={(e) => { if (e.key === 'Enter') handleCommand(input); }} />
                <Button size="sm" onClick={() => handleCommand(input)} aria-label="run">‚ñ∂</Button>
              </div>
              <div className="max-h-64 overflow-auto text-sm font-mono space-y-1">
                {hud.log.map((l) => (<div key={l.id}>[{new Date(l.ts).toLocaleTimeString()}] {l.text}</div>))}
              </div>
            </CardContent>
          </Card>
        </div>

        {/* Right Column ‚Äî REFLECTION */}
        <div className="space-y-4 min-w-0">
          <Card className={`${theme.card} ${theme.border} ${theme.cardText}`}>
            <CardHeader className="pb-2"><CardTitle><Moon className="h-4 w-4 inline mr-1" />Rituals</CardTitle></CardHeader>
            <CardContent className="space-y-3">
              {hud.rituals.map((r) => (
                <motion.div key={r.id} className={`flex justify-between rounded-xl border p-3 ${r.done ? "bg-green-900/40 border-green-400" : "bg-neutral-900/30"}`}>
                  <div className="flex items-center gap-3">
                    <Button size="sm" className={r.done ? sel : uns}
                      onClick={() => {
                        setHud((s) => ({ ...s, rituals: s.rituals.map((rr) => rr.id === r.id ? { ...rr, done: !rr.done } : rr) }));
                        addLog(`${r.done ? "‚úó" : "‚úî"} Ritual ${r.title}`);
                      }}>{r.done ? "‚òÖ" : "‚ú¶"}</Button>
                    <div>
                      <div className="text-sm font-medium">{r.emoji} {r.title}</div>
                      <div className={`text-xs ${theme.textMuted}`}>award: {Object.entries(r.xpAward).map(([k, v]) => `${k}+${v}`).join(" ")}</div>
                    </div>
                  </div>
                  <Badge className={theme.badge}>{r.schedule}</Badge>
                </motion.div>
              ))}
            </CardContent>
          </Card>

          <Card className={`${theme.card} ${theme.border} ${theme.cardText}`}>
            <CardHeader className="pb-2"><CardTitle><Calendar className="h-4 w-4 inline mr-1" />Arc ¬∑ Quest</CardTitle></CardHeader>
            <CardContent>
              <div className="space-y-1">
                <div><span className={`${theme.textMuted} mr-2`}>Arc</span><span className="font-medium">A1 ‚Äî Awakening</span></div>
                <div><span className={`${theme.textMuted} mr-2`}>Quest</span><span className="font-medium">Stabilize ritual loop</span></div>
              </div>
            </CardContent>
          </Card>

          {SHOW_TESTS && (
            <Card className={`${theme.card} ${theme.border} ${theme.cardText}`}>
              <CardHeader className="pb-2"><CardTitle>Tests</CardTitle></CardHeader>
              <CardContent>
                <Button size="sm" onClick={runTests}>Run Tests</Button>
                <div className="mt-2 text-xs space-y-1">
                  {testOutput.map((t, i) => (<div key={i}>‚Ä¢ {t}</div>))}
                </div>
                <div className={`mt-2 text-xs ${theme.textMuted}`}>Hint: append <code>#test</code> to URL to show this panel.</div>
              </CardContent>
            </Card>
          )}
        </div>
      </div>
    </div>
  );
}
