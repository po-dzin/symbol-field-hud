<!doctype html>
<html lang="ru">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>SymbolField HUD</title>
<style>
:root{--bg:#fafafa;--fg:#111;--border:#e6e6e6;--muted:#666;}
body[data-theme="dark"]{--bg:#0f0f0f;--fg:#fafafa;--border:#222;}
body[data-theme="zen"]{--bg:#f9f7f2;--fg:#222;}
body[data-theme="light"]{--bg:#ffffff;--fg:#111;}
body{
 background:var(--bg);color:var(--fg);
 font:15px/1.5 Inter,system-ui,sans-serif;margin:0;
 transition:background .6s ease,color .3s ease;
}
/* mood-based gradients */
body[data-mood="🔴"]{background:radial-gradient(circle at 50% 20%,#ffb3b3,#1a0000);}
body[data-mood="🟠"]{background:radial-gradient(circle at 50% 20%,#ffd8b3,#331500);}
body[data-mood="🟢"]{background:radial-gradient(circle at 50% 20%,#c6ffcc,#00280d);}
body[data-mood="🔵"]{background:radial-gradient(circle at 50% 20%,#b3e1ff,#001433);}
body[data-mood="🟣"]{background:radial-gradient(circle at 50% 20%,#e5b3ff,#2b0044);}
h1{text-align:center;margin:20px 0;font-size:2rem;font-weight:600;letter-spacing:.03em;
 background:linear-gradient(90deg,#111,#555);
 -webkit-background-clip:text;-webkit-text-fill-color:transparent;}
body[data-mode="🔆"] h1{background:linear-gradient(90deg,#ff9800,#ffc400);}
body[data-mode="♾️"] h1{background:linear-gradient(90deg,#38bdf8,#a855f7);}
body[data-mode="🕳️"] h1{background:linear-gradient(90deg,#111,#333);}
.grid{max-width:1100px;margin:auto;display:grid;gap:18px;padding:0 16px}
@media(min-width:900px){.grid{grid-template-columns:280px 1fr 280px}}
.card{background:#fff;border:1px solid var(--border);border-radius:14px;overflow:hidden}
.hd{padding:12px 14px;border-bottom:1px solid var(--border);display:flex;justify-content:space-between;align-items:center}
.bd{padding:12px 14px}
.row{display:flex;align-items:center;gap:6px;flex-wrap:wrap}
.badge{border:1px solid var(--border);border-radius:999px;padding:3px 8px;font-size:12px}
.btn{border:1px solid var(--border);border-radius:999px;padding:5px 10px;background:none;cursor:pointer}
.btn[aria-current="true"]{background:var(--fg);color:var(--bg)}
.mono{font-family:ui-monospace,monospace}
.progress{height:6px;background:#e6e6e6;border-radius:999px;overflow:hidden}
.bar{height:100%;background:var(--fg)}
.hint{font-size:12px;color:var(--muted)}
.list{max-height:220px;overflow:auto;border:1px solid var(--border);border-radius:10px}
.item{padding:6px 10px;border-bottom:1px solid var(--border)}
</style>
</head>
<body data-mode="♾️" data-theme="status" data-mood="🟢">
<h1>SymbolField HUD</h1>
<div class="grid">
  <!-- LEFT: STATE -->
  <div>
    <div class="card">
      <div class="hd"><div id="t_state"></div>
        <div><select id="lang">
          <option value="ru">RU</option><option value="en">EN</option></select></div></div>
      <div class="bd">
        <div id="dateMoon"></div>

        <div class="row mt8" data-group="mode">
          <span class="badge">Mode</span>
          <button class="btn" id="m1" type="button" data-mode="🕳️">🕳️</button>
          <button class="btn" id="m2" type="button" data-mode="♾️">♾️</button>
          <button class="btn" id="m3" type="button" data-mode="🔆">🔆</button>
        </div>
        <div class="hint" id="mode_hint"></div>

        <div class="row mt8" data-group="mood">
          <span class="badge">Mood</span>
          <button class="btn" id="mo1" type="button" data-mood="🔴">🔴</button>
          <button class="btn" id="mo2" type="button" data-mood="🟠">🟠</button>
          <button class="btn" id="mo3" type="button" data-mood="🟢">🟢</button>
          <button class="btn" id="mo4" type="button" data-mood="🔵">🔵</button>
          <button class="btn" id="mo5" type="button" data-mood="🟣">🟣</button>
        </div>
        <div class="hint" id="mood_hint"></div>

        <div class="row mt8" data-group="glyph">
          <span class="badge">Glyph</span>
          <button class="btn" id="g1" type="button" data-glyph="•">•</button><button class="btn" id="g2" type="button" data-glyph="∣">∣</button>
          <button class="btn" id="g3" type="button" data-glyph="◯">◯</button><button class="btn" id="g4" type="button" data-glyph="⊙">⊙</button>
          <button class="btn" id="g5" type="button" data-glyph="∿">∿</button>
        </div>
      </div>
    </div>

    <div class="card mt16"><div class="hd"><div id="t_xp"></div></div>
      <div class="bd" id="xp"></div>
    </div>
  </div>

  <!-- CENTER -->
  <div>
    <div class="card"><div class="hd"><div>/arc + /quest</div></div>
      <div class="bd" id="arcquest">Arc A1 — Awakening · Quest: Stabilize ritual loop</div></div>
    <div class="card mt16"><div class="hd"><div>/quote</div></div>
      <div class="bd" id="quote">«Кольцо дышит. Зерно светится. Тишина держит форму.»</div></div>
    <div class="card mt16"><div class="hd"><div>/reminder</div></div>
      <div class="bd">∣ ◯ ⊙ → Vipassana + breath + charge (08:00)</div></div>
  </div>

  <!-- RIGHT -->
  <div>
    <div class="card"><div class="hd"><div>/xp + /audit</div></div>
      <div class="bd list" id="log"></div></div>
    <div class="card mt16"><div class="hd"><div>Theme</div></div>
      <div class="bd">
        <select id="theme">
          <option value="status">Status-depended</option>
          <option value="dark">Dark</option>
          <option value="zen">Zen</option>
          <option value="light">Light</option>
        </select>
      </div></div>
  </div>
</div>

<script>
const TEXT={ru:{state:"Состояние",xp:"Панель опыта"},
            en:{state:"State",xp:"XP Dashboard"}};
const MODES=["🕳️","♾️","🔆"];
const MOODS=["🔴","🟠","🟢","🔵","🟣"];
const GLYPHS=["•","∣","◯","⊙","∿"];
const THEMES=["status","dark","zen","light"];
const MODE_HINTS={"🕳️":"shadow · depth · compression",
                  "♾️":"flow · synthesis · resonance",
                  "🔆":"radiance · broadcast · clarity"};
const MOOD_HINTS={
  "🔴":"vital · active · embodied",
  "🟠":"creative · expressive · warm",
  "🟢":"balanced · centered · organic",
  "🔵":"clear · focused · calm",
  "🟣":"integral · inspired · subtle"
};
const XP_SYMBOLS={HP:"🪨",CP:"💧",MP:"🔥",DP:"🌬️"};
const XP=Object.freeze({HP:15,CP:3,MP:3,DP:29});
const STORAGE_KEY="symbolFieldHUDState";
const DEFAULT_STATE=Object.freeze({
  lang:"ru",
  mode:MODES[1],
  mood:MOODS[2],
  glyph:GLYPHS[2],
  theme:THEMES[0]
});

const $={
  body:document.body,
  stateTitle:document.getElementById("t_state"),
  xpTitle:document.getElementById("t_xp"),
  xpPanel:document.getElementById("xp"),
  modeHint:document.getElementById("mode_hint"),
  moodHint:document.getElementById("mood_hint"),
  log:document.getElementById("log"),
  theme:document.getElementById("theme"),
  lang:document.getElementById("lang"),
  dateMoon:document.getElementById("dateMoon")
};

function safeStorage(){
  try{return window.localStorage;}catch{return null;}
}

const storage=safeStorage();
const VALIDATORS={
  lang:value=>Boolean(TEXT[value]),
  mode:value=>MODES.includes(value),
  mood:value=>MOODS.includes(value),
  glyph:value=>GLYPHS.includes(value),
  theme:value=>THEMES.includes(value)
};

function loadState(){
  if(!storage)return {...DEFAULT_STATE};
  try{
    const parsed=JSON.parse(storage.getItem(STORAGE_KEY)||"{}");
    if(!parsed||typeof parsed!=="object")return {...DEFAULT_STATE};
    const state={...DEFAULT_STATE};
    for(const key of Object.keys(state)){
      const candidate=parsed[key];
      if(typeof candidate==="string"&&VALIDATORS[key]?.(candidate)){
        state[key]=candidate;
      }
    }
    return state;
  }catch{
    return {...DEFAULT_STATE};
  }
}

let state=loadState();
if(storage){
  const storedLang=storage.getItem("lang");
  if(storedLang&&TEXT[storedLang]){
    state={...state,lang:storedLang};
  }
}

function saveState(){
  if(!storage)return;
  try{
    storage.setItem(STORAGE_KEY,JSON.stringify(state));
    storage.setItem("lang",state.lang);
  }catch{
    /* ignore quota errors */
  }
}

function renderXp(){
  $.xpPanel.textContent="";
  const frag=document.createDocumentFragment();
  for(const [label,value] of Object.entries(XP)){
    const wrapper=document.createElement("div");
    wrapper.className="mt8";

    const row=document.createElement("div");
    row.className="row";
    const strong=document.createElement("strong");
    strong.textContent=label;
    const icon=document.createElement("span");
    icon.textContent=XP_SYMBOLS[label]||"";
    const amount=document.createElement("span");
    amount.className="mono";
    amount.textContent=String(value);
    row.append(strong,icon,amount);

    const progress=document.createElement("div");
    progress.className="progress";
    const bar=document.createElement("div");
    bar.className="bar";
    const pct=Math.min(100,value%100);
    bar.style.width=`${pct}%`;
    progress.append(bar);

    wrapper.append(row,progress);
    frag.append(wrapper);
  }
  $.xpPanel.append(frag);
}

function markSelection(selector,key){
  document.querySelectorAll(selector).forEach(btn=>{
    const value=btn.dataset[key];
    if(!value)return;
    btn.toggleAttribute("aria-current",value===state[key]);
  });
}

function render(){
  $.body.dataset.mode=state.mode;
  $.body.dataset.mood=state.mood;
  $.body.dataset.theme=state.theme==="status"?state.mode:state.theme;

  const text=TEXT[state.lang]||TEXT.ru;
  $.stateTitle.textContent=text.state;
  $.xpTitle.textContent=text.xp;
  $.modeHint.textContent=MODE_HINTS[state.mode]||"";
  $.moodHint.textContent=MOOD_HINTS[state.mood]||"";

  $.lang.value=state.lang;
  $.theme.value=state.theme;

  markSelection('[data-mode]','mode');
  markSelection('[data-mood]','mood');
  markSelection('[data-glyph]','glyph');

  renderXp();
}

function setState(patch,logMessage){
  const next={...state,...patch};
  const changed=Object.keys(patch).some(key=>state[key]!==next[key]);
  state=next;
  if(changed){
    saveState();
    render();
    if(logMessage){
      log(logMessage);
    }
  }
}

function log(message){
  const entry=document.createElement("div");
  entry.className="item mono";
  entry.textContent=`[${new Date().toLocaleTimeString()}] ${message}`;
  $.log.prepend(entry);
  while($.log.children.length>50){
    $.log.removeChild($.log.lastElementChild);
  }
}

document.querySelectorAll('[data-mode]').forEach(button=>{
  button.addEventListener('click',()=>{
    const value=button.dataset.mode;
    if(!value)return;
    setState({mode:value},`∷ Mode → ${value}`);
  });
});

document.querySelectorAll('[data-mood]').forEach(button=>{
  button.addEventListener('click',()=>{
    const value=button.dataset.mood;
    if(!value)return;
    setState({mood:value},`♦ Mood → ${value}`);
  });
});

document.querySelectorAll('[data-glyph]').forEach(button=>{
  button.addEventListener('click',()=>{
    const value=button.dataset.glyph;
    if(!value)return;
    setState({glyph:value},`◐ Glyph → ${value}`);
  });
});

$.theme.addEventListener('change',event=>{
  const value=event.target.value;
  setState({theme:value},`☼ Theme → ${value}`);
});

$.lang.addEventListener('change',event=>{
  const value=event.target.value;
  setState({lang:value});
  updateMoon();
});

// 🌕 Moon phase + quarters
async function updateMoon(){
  const now=Math.floor(Date.now()/1000);
  try{
    const res=await fetch(`https://api.farmsense.net/v1/moonphases/?d=${now}`);
    const data=await res.json();
    const phase=data?.[0]?.Phase||"unknown";
    let icon="🌘",quarter=4;
    if(phase.includes("New")){icon="🌑";quarter=1;}
    else if(phase.includes("Waxing Crescent")){icon="🌒";quarter=1;}
    else if(phase.includes("First Quarter")){icon="🌓";quarter=2;}
    else if(phase.includes("Waxing Gibbous")){icon="🌔";quarter=2;}
    else if(phase.includes("Full")){icon="🌕";quarter=3;}
    else if(phase.includes("Waning Gibbous")){icon="🌖";quarter=3;}
    else if(phase.includes("Last Quarter")){icon="🌗";quarter=4;}
    else if(phase.includes("Waning Crescent")){icon="🌘";quarter=4;}
    const dateStr=new Date().toLocaleDateString(state.lang==="ru"?"ru-RU":"en-GB",{
      day:"numeric",month:"long",year:"numeric"
    });
    $.dateMoon.textContent=`${dateStr} · ${icon} ${phase} · Q${quarter}`;
  }catch{
    $.dateMoon.textContent="Moon API unavailable";
  }
}

render();
updateMoon();
</script>
</body>
</html>
