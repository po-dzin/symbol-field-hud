<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>SymbolField HUD ‚Äî Demo (Single File)</title>
  <style>
    :root{
      --bg:#fafafa;--fg:#111;--muted:#666;--border:#e6e6e6;
      --accent:#111;--chip:#f1f1f1;--ok:#eaffea;--okb:#b7e0b7;
    }
    *{box-sizing:border-box}
    body{margin:0;background:var(--bg);color:var(--fg);font:14px/1.45 -apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Inter,Helvetica,Arial,sans-serif}
    .wrap{max-width:1120px;margin:0 auto;padding:20px}
    h1{font-size:18px;margin:0 0 8px}
    .grid{display:grid;gap:16px}
    @media(min-width:1000px){.grid{grid-template-columns:280px 1fr 280px}}
    .card{background:#fff;border:1px solid var(--border);border-radius:14px;box-shadow:0 0 0 rgba(0,0,0,0.02)}
    .card .hd{padding:14px 14px 8px;border-bottom:1px solid var(--border);display:flex;align-items:center;justify-content:space-between}
    .card .bd{padding:12px 14px}
    .row{display:flex;align-items:center;gap:8px;flex-wrap:wrap}
    .badge{border:1px solid var(--border);background:var(--chip);border-radius:999px;padding:3px 8px;font-size:12px}
    .btn{border:1px solid var(--border);background:#fff;border-radius:999px;padding:6px 10px;cursor:pointer}
    .btn[aria-current="true"]{background:#111;color:#fff;border-color:#111}
    .btn.small{padding:4px 8px;font-size:12px}
    .chip{padding:6px 10px;border:1px solid var(--border);border-radius:12px}
    .muted{color:var(--muted)}
    .list{display:flex;flex-direction:column;border:1px solid var(--border);border-radius:10px;overflow:hidden;max-height:260px;overflow:auto}
    .item{display:flex;align-items:center;justify-content:space-between;padding:10px 12px;border-bottom:1px solid var(--border)}
    .item:last-child{border-bottom:none}
    .ok{background:var(--ok);border-color:var(--okb)}
    .mono{font-family:ui-monospace,SFMono-Regular,Menlo,Consolas,monospace}
    .input{width:100%;padding:8px 10px;border:1px solid var(--border);border-radius:10px}
    .mt8{margin-top:8px}.mt12{margin-top:12px}.mt16{margin-top:16px}
    .between{display:flex;align-items:center;justify-content:space-between}
    .progress{height:6px;background:#f0f0f0;border-radius:999px;overflow:hidden}
    .bar{height:100%;background:#111;width:0%}
    .hint{font-size:12px;color:var(--muted)}
    .col{display:flex;flex-direction:column;gap:8px}
    .stack2{display:grid;grid-template-columns:1fr auto;gap:8px}
  </style>
</head>
<body>
  <div class="wrap">
    <h1>SymbolField HUD ‚Äî –¥–µ–º–æ</h1>
    <div class="grid">
      <!-- LEFT: Status + XP -->
      <div class="col">
        <div class="card">
          <div class="hd"><div>–°—Ç–∞—Ç—É—Å</div><div class="badge mono" id="date"></div></div>
          <div class="bd">
            <div class="row">
              <div class="badge">Mode</div>
              <button class="btn small" id="m_shadow" data-mode="üï≥Ô∏è" data-role="mode">üï≥Ô∏è</button>
              <button class="btn small" id="m_flow" data-mode="‚ôæÔ∏è" data-role="mode">‚ôæÔ∏è</button>
              <button class="btn small" id="m_radiance" data-mode="üîÜ" data-role="mode">üîÜ</button>
            </div>
            <div class="hint mt8" id="mode_hint">flow ¬∑ synthesis ¬∑ resonance</div>
            <div class="row mt12">
              <div class="badge">Glyph</div>
              <button class="btn small" id="g_dot" data-glyph="‚Ä¢" data-role="glyph">‚Ä¢</button>
              <button class="btn small" id="g_bar" data-glyph="‚à£" data-role="glyph">‚à£</button>
              <button class="btn small" id="g_circle" data-glyph="‚óØ" data-role="glyph">‚óØ</button>
              <button class="btn small" id="g_core" data-glyph="‚äô" data-role="glyph">‚äô</button>
              <button class="btn small" id="g_drift" data-glyph="‚àø" data-role="glyph">‚àø</button>
            </div>
            <div class="hint mt8">–∞–∫—Ç–∏–≤–Ω—ã–π –∑–Ω–∞–∫ –≤–ª–∏—è–µ—Ç –Ω–∞ —Ç–µ–≥–∏ –∞—Ä—Ç–µ—Ñ–∞–∫—Ç–æ–≤</div>
          </div>
        </div>

        <div class="card">
          <div class="hd"><div>XP Ledger</div></div>
          <div class="bd">
            <div id="xp_list"></div>
            <div class="between hint mt8"><span>Total</span><span class="mono" id="xp_total">0</span></div>
          </div>
        </div>
      </div>

      <!-- CENTER: Rituals + Log -->
      <div class="col">
        <div class="card">
          <div class="hd">
            <div>Rituals <span class="badge">daily</span></div>
            <div class="row">
              <button class="btn small" id="reset_btn">‚Üª Reset</button>
            </div>
          </div>
          <div class="bd" id="rituals"></div>
        </div>

        <div class="card">
          <div class="hd"><div>Canvas ¬∑ Log</div></div>
          <div class="bd">
            <div class="stack2">
              <input id="cmd" class="input mono" placeholder="/mode ‚ôæÔ∏è | /glyph ‚äô | /xp HP+3 CP+2 | write a note" />
              <button class="btn" id="run">Run ‚ñ∂</button>
            </div>
            <div class="list mt12" id="log"></div>
          </div>
        </div>
      </div>

      <!-- RIGHT: Quick + Focus + Export -->
      <div class="col">
        <div class="card">
          <div class="hd"><div>Quick Actions</div></div>
          <div class="bd">
            <div class="row">
              <button class="btn small" id="qa_shadow" data-mode="üï≥Ô∏è">üï≥Ô∏è Shadow</button>
              <button class="btn small" id="qa_flow" data-mode="‚ôæÔ∏è">‚ôæÔ∏è Flow</button>
              <button class="btn small" id="qa_radiance" data-mode="üîÜ">üîÜ Radiance</button>
            </div>
            <div class="row mt8">
              <button class="btn small" id="qa_core" data-glyph="‚äô">‚äô Core</button>
              <button class="btn small" id="qa_drift" data-glyph="‚àø">‚àø Drift</button>
              <button class="btn small" id="qa_allxp">+ All XP</button>
            </div>
          </div>
        </div>

        <div class="card">
          <div class="hd"><div>Today Focus</div></div>
          <div class="bd">
            <div class="between"><span>Lower triad</span><span class="badge">ü¶∂Ô∏é‚Üíü™∂‚Üíü¶∑</span></div>
            <div class="between mt8"><span>Higher triad</span><span class="badge">üå¨Ô∏è‚ÜíüëÅÔ∏è‚Äçüó®Ô∏è‚Üíüó£Ô∏è</span></div>
            <div class="hint mt12">‚Äú–ö–æ–ª—å—Ü–æ –¥—ã—à–∏—Ç. –ó–µ—Ä–Ω–æ —Å–≤–µ—Ç–∏—Ç—Å—è. –¢–∏—à–∏–Ω–∞ –¥–µ—Ä–∂–∏—Ç —Ñ–æ—Ä–º—É.‚Äù</div>
          </div>
        </div>

        <div class="card">
          <div class="hd"><div>Export / Import</div></div>
          <div class="bd">
            <div class="row">
              <button class="btn" id="export_json">‚¨á Export JSON</button>
              <label class="btn" for="import_json">‚¨Ü Import JSON</label>
              <input type="file" id="import_json" accept="application/json" style="display:none" />
            </div>
            <div class="hint mt8">–û–¥–∏–Ω —Ñ–∞–π–ª ‚Äî –º–æ–∂–Ω–æ –∑–∞–≥—Ä—É–∑–∏—Ç—å –Ω–∞ GitHub Pages / Vercel / Netlify Drop.</div>
          </div>
        </div>
      </div>
    </div>
  </div>

<script>
  (function () {
    const STORAGE_KEY = "symbolfield_hud_demo_v1";
    const TODAY = new Date().toISOString().slice(0, 10);

    const MODE_OPTIONS = [
      { value: "üï≥Ô∏è", hint: "shadow ¬∑ depth ¬∑ compression" },
      { value: "‚ôæÔ∏è", hint: "flow ¬∑ synthesis ¬∑ resonance" },
      { value: "üîÜ", hint: "radiance ¬∑ broadcast ¬∑ clarity" },
    ];
    const GLYPH_VALUES = ["‚Ä¢", "‚à£", "‚óØ", "‚äô", "‚àø"];
    const XP_TRACKS = [
      { key: "HP", icon: "ü™®" },
      { key: "CP", icon: "üíß" },
      { key: "MP", icon: "üî•" },
      { key: "DP", icon: "üå¨Ô∏è" },
    ];

    const DEFAULT_RITUALS = [
      {
        id: "vipassana",
        title: "Vipassana + breath + charge",
        emoji: "üßò‚Äç‚ôÇÔ∏è",
        xpAward: { DP: 8, HP: 2 },
        schedule: "daily",
        done: false,
      },
      {
        id: "move10",
        title: "10m mobility / flow",
        emoji: "üåÄ",
        xpAward: { HP: 6, DP: 2 },
        schedule: "adhoc",
        done: false,
      },
      {
        id: "create20",
        title: "20m glyph/sound sketch",
        emoji: "‚úçÔ∏è",
        xpAward: { CP: 8, MP: 2 },
        schedule: "adhoc",
        done: false,
      },
    ];

    const MODE_HINTS = Object.fromEntries(
      MODE_OPTIONS.map(({ value, hint }) => [value, hint])
    );

    function createDefaultState() {
      return {
        date: TODAY,
        mode: "‚ôæÔ∏è",
        glyph: "‚óØ",
        xp: Object.fromEntries(XP_TRACKS.map(({ key }) => [key, 0])),
        rituals: DEFAULT_RITUALS.map((ritual) => ({
          ...ritual,
          xpAward: { ...ritual.xpAward },
          done: false,
        })),
        log: [],
      };
    }

    function createStateFrom(raw) {
      const next = createDefaultState();
      if (!raw || typeof raw !== "object") return next;

      if (typeof raw.date === "string") next.date = raw.date;
      if (MODE_HINTS[raw.mode]) next.mode = raw.mode;
      if (GLYPH_VALUES.includes(raw.glyph)) next.glyph = raw.glyph;

      if (raw.xp && typeof raw.xp === "object") {
        XP_TRACKS.forEach(({ key }) => {
          const value = Number(raw.xp[key]);
          if (Number.isFinite(value)) next.xp[key] = value;
        });
      }

      if (Array.isArray(raw.rituals)) {
        next.rituals = raw.rituals.map((ritual) => {
          const normalized = {
            id:
              typeof ritual.id === "string" && ritual.id.trim()
                ? ritual.id
                : crypto.randomUUID(),
            title: typeof ritual.title === "string" ? ritual.title : "",
            emoji: typeof ritual.emoji === "string" ? ritual.emoji : "",
            xpAward: {},
            schedule:
              typeof ritual.schedule === "string" && ritual.schedule.trim()
                ? ritual.schedule
                : "adhoc",
            done: Boolean(ritual.done),
          };

          if (ritual.xpAward && typeof ritual.xpAward === "object") {
            XP_TRACKS.forEach(({ key }) => {
              const value = Number(ritual.xpAward[key]);
              if (Number.isFinite(value)) normalized.xpAward[key] = value;
            });
          }

          return normalized;
        });
      }

      if (Array.isArray(raw.log)) {
        next.log = raw.log
          .filter((entry) => entry && typeof entry.text === "string")
          .map((entry) => ({
            id:
              typeof entry.id === "string" && entry.id.trim()
                ? entry.id
                : crypto.randomUUID(),
            ts: Number.isFinite(Number(entry.ts))
              ? Number(entry.ts)
              : Date.now(),
            text: entry.text,
          }))
          .slice(0, 200);
      }

      return next;
    }

    function load() {
      try {
        const raw = localStorage.getItem(STORAGE_KEY);
        if (!raw) return createDefaultState();
        const parsed = createStateFrom(JSON.parse(raw));
        if (parsed.date !== TODAY) {
          parsed.date = TODAY;
          parsed.rituals = parsed.rituals.map((ritual) => ({
            ...ritual,
            done: false,
          }));
          parsed.log.unshift({
            id: crypto.randomUUID(),
            ts: Date.now(),
            text: `‚Üª New day ${TODAY}: rituals reset`,
          });
          parsed.log = parsed.log.slice(0, 200);
        }
        return parsed;
      } catch (error) {
        console.warn("Failed to load state", error);
        return createDefaultState();
      }
    }

    function save() {
      localStorage.setItem(STORAGE_KEY, JSON.stringify(state));
    }

    let state = load();

    const dom = {
      date: document.getElementById("date"),
      modeHint: document.getElementById("mode_hint"),
      xpList: document.getElementById("xp_list"),
      xpTotal: document.getElementById("xp_total"),
      rituals: document.getElementById("rituals"),
      log: document.getElementById("log"),
      cmd: document.getElementById("cmd"),
    };

    function sync() {
      render();
      save();
    }

    function addLog(text) {
      state.log.unshift({ id: crypto.randomUUID(), ts: Date.now(), text });
      state.log = state.log.slice(0, 200);
    }

    function awardXP(delta, reason) {
      XP_TRACKS.forEach(({ key }) => {
        const increment = Number(delta[key]) || 0;
        state.xp[key] = (state.xp[key] || 0) + increment;
      });
      const pretty = Object.entries(delta)
        .filter(([, value]) => Number(value))
        .map(([key, value]) => `${key}+${value}`)
        .join(" ");
      if (pretty) {
        addLog(`+XP ${pretty} ‚Äî ${reason}`);
      }
    }

    function toggleRitual(id) {
      const ritual = state.rituals.find((item) => item.id === id);
      if (!ritual) return;
      ritual.done = !ritual.done;
      if (ritual.done) {
        awardXP(ritual.xpAward, `‚úî ${ritual.title}`);
      } else {
        addLog(`‚òê ${ritual.title} ‚Äî undone`);
      }
      sync();
    }

    function setMode(value) {
      state.mode = value;
      addLog(`‚à∑ Mode ‚Üí ${value}`);
      sync();
    }

    function setGlyph(value) {
      state.glyph = value;
      addLog(`‚óê Glyph ‚Üí ${value}`);
      sync();
    }

    function handleCommand(raw) {
      const text = raw.trim();
      if (!text) return;

      const [command, ...rest] = text.split(/\s+/);
      if (command === "/mode") {
        const value = rest[0];
        if (MODE_HINTS[value]) {
          setMode(value);
        } else {
          addLog(`? Unknown mode: ${value || ""}`);
          sync();
        }
      } else if (command === "/glyph") {
        const value = rest[0];
        if (GLYPH_VALUES.includes(value)) {
          setGlyph(value);
        } else {
          addLog(`? Unknown glyph: ${value || ""}`);
          sync();
        }
      } else if (command === "/xp") {
        const delta = {};
        rest.forEach((part) => {
          const match = part.match(/(HP|CP|MP|DP)\+(\d+)/);
          if (match) delta[match[1]] = Number(match[2]);
        });
        if (Object.keys(delta).length) {
          awardXP(delta, "manual");
          sync();
        } else {
          addLog("? No XP parsed");
          sync();
        }
      } else if (command === "/reset") {
        state.rituals.forEach((ritual) => {
          ritual.done = false;
        });
        addLog("‚Ü∫ HUD soft reset (rituals/log)");
        state.log = state.log.slice(0, 200);
        sync();
      } else {
        addLog(text);
        sync();
      }

      dom.cmd.value = "";
    }

    function exportJSON() {
      const blob = new Blob([JSON.stringify(state, null, 2)], {
        type: "application/json",
      });
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = `symbolfield_hud_${state.date}.json`;
      a.click();
      URL.revokeObjectURL(url);
    }

    function importJSON(file) {
      const reader = new FileReader();
      reader.onload = () => {
        try {
          const data = JSON.parse(String(reader.result));
          state = createStateFrom(data);
          addLog("‚¨ë Imported state JSON");
          sync();
        } catch (error) {
          console.warn("Import failed", error);
          addLog("! Import failed");
          sync();
        }
      };
      reader.readAsText(file);
    }

    function renderMode() {
      dom.modeHint.textContent = MODE_HINTS[state.mode] || "";
      document.querySelectorAll('[data-role="mode"]').forEach((button) => {
        button.toggleAttribute("aria-current", button.dataset.mode === state.mode);
      });
    }

    function renderGlyph() {
      document.querySelectorAll('[data-role="glyph"]').forEach((button) => {
        button.toggleAttribute(
          "aria-current",
          button.dataset.glyph === state.glyph
        );
      });
    }

    function renderXp() {
      const fragment = document.createDocumentFragment();
      let total = 0;

      XP_TRACKS.forEach(({ key, icon }) => {
        const value = Number(state.xp[key]) || 0;
        total += value;

        const wrapper = document.createElement("div");
        wrapper.className = "mt8";

        const header = document.createElement("div");
        header.className = "between";

        const row = document.createElement("div");
        row.className = "row";

        const label = document.createElement("strong");
        label.textContent = key;

        const iconEl = document.createElement("span");
        iconEl.textContent = icon;

        row.append(label, iconEl);

        const valueEl = document.createElement("span");
        valueEl.className = "mono";
        valueEl.textContent = String(value);

        header.append(row, valueEl);

        const progress = document.createElement("div");
        progress.className = "progress";
        const bar = document.createElement("div");
        bar.className = "bar";
        bar.style.width = `${Math.min(100, value % 100)}%`;
        progress.append(bar);

        wrapper.append(header, progress);
        fragment.append(wrapper);
      });

      dom.xpList.replaceChildren(fragment);
      dom.xpTotal.textContent = String(total);
    }

    function renderRituals() {
      const fragment = document.createDocumentFragment();

      state.rituals.forEach((ritual) => {
        const item = document.createElement("div");
        item.className = `item${ritual.done ? " ok" : ""}`;

        const row = document.createElement("div");
        row.className = "row";

        const toggle = document.createElement("button");
        toggle.className = "btn small";
        toggle.dataset.ritualToggle = ritual.id;
        toggle.textContent = ritual.done ? "‚òÖ" : "‚ú¶";

        const details = document.createElement("div");
        const title = document.createElement("div");
        const titleText = document.createElement("strong");
        titleText.textContent = `${ritual.emoji} ${ritual.title}`.trim();
        title.append(titleText);

        const hint = document.createElement("div");
        hint.className = "hint";
        const awards = Object.entries(ritual.xpAward || {})
          .map(([key, value]) => `${key}+${value}`)
          .join(" ");
        hint.textContent = awards ? `award: ${awards}` : "award: ‚Äî";

        details.append(title, hint);

        row.append(toggle, details);
        item.append(row);

        const badge = document.createElement("span");
        badge.className = "badge";
        badge.textContent = ritual.schedule;
        item.append(badge);

        fragment.append(item);
      });

      dom.rituals.replaceChildren(fragment);
    }

    function renderLog() {
      const fragment = document.createDocumentFragment();

      state.log.forEach((entry) => {
        const item = document.createElement("div");
        item.className = "item";

        const text = document.createElement("div");
        text.className = "mono";
        text.textContent = `[${new Date(entry.ts).toLocaleTimeString()}] ${entry.text}`;

        item.append(text);
        fragment.append(item);
      });

      dom.log.replaceChildren(fragment);
    }

    function render() {
      dom.date.textContent = state.date;
      renderMode();
      renderGlyph();
      renderXp();
      renderRituals();
      renderLog();
    }

    function attachChoiceHandlers(attribute, setter) {
      document.querySelectorAll(`[data-${attribute}]`).forEach((button) => {
        button.addEventListener("click", () => setter(button.dataset[attribute]));
      });
    }

    attachChoiceHandlers("mode", setMode);
    attachChoiceHandlers("glyph", setGlyph);

    document
      .getElementById("qa_allxp")
      .addEventListener("click", () => {
        awardXP({ HP: 3, CP: 3, MP: 3, DP: 3 }, "quick");
        sync();
      });

    document
      .getElementById("reset_btn")
      .addEventListener("click", () => {
        state = load();
        sync();
      });

    document.getElementById("run").addEventListener("click", () => {
      handleCommand(dom.cmd.value);
    });

    dom.cmd.addEventListener("keydown", (event) => {
      if (event.key === "Enter") {
        handleCommand(dom.cmd.value);
      }
    });

    dom.rituals.addEventListener("click", (event) => {
      const target = event.target.closest("[data-ritual-toggle]");
      if (target) {
        toggleRitual(target.dataset.ritualToggle);
      }
    });

    document
      .getElementById("export_json")
      .addEventListener("click", exportJSON);

    document
      .getElementById("import_json")
      .addEventListener("change", (event) => {
        const file = event.target.files && event.target.files[0];
        if (file) {
          importJSON(file);
          event.target.value = "";
        }
      });

    render();
    save();
  })();
</script>
</body>
</html>
